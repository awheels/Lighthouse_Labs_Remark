<div id="document-page-box" class="container default-box">
  <div class="col-md-12">
    <div class="row">
      <div class="col-xs-9 document_title"> <h1><%=@document.title%></h1><p id="document_page_author"><%=User.find(@document.user_id).username%></p></div>
      <div class="column-md-3 col-md-offset-9">
        <div class="side-comment">
          <span id = "comment-select-button" class="fa fa-font fa-lg"></span>
          <div class="spacer">
            <form class="comment-form-select" role="form" method="post" action="/" placeholder="Select something">
              <textarea  class="form-control" id="comment-submit-textbox" rows="1" name="comment"></textarea>
              <div class="spacer"></div>
              <input type="hidden" name="paragraph_id" value=1>
              <div>
                <input type="submit" class="btn btn-default" value="Submit">
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
      <% @document.paragraphs.each do |paragraph| %>
        
        <div class="row-fluid">
          <div class="col-xs-9 paragraph_body" data-target="#comment_for_paragraph_<%=paragraph.id%>"> <%= paragraph.body %></div>
          <div id="comment_for_paragraph_<%=paragraph.id%>" class="col-xs-3 comment_bar">
            <% paragraph.comments.each do |comment| %>
            <div>
              <div>
                <%= comment.content %>
                
              </div>
              <div class="col-xs-12 comment_user">

                - <em><%= User.find(comment.user_id).username%></em>
              </div>
            </div>
              
            <% end %>
            <%if session[:id]%>
              <div>
                <span onclick="$('#comment_form_<%= paragraph.id%>').toggle();" id="comment-view-button" class="fa fa-comment fa-lg"></span>
              </div>
              <div class="spacer"></div>
              <form class="comment_form" id="comment_form_<%= paragraph.id%>" role="form" method="post" action="/comment" placeholder="Comment..">
                <textarea class="form-control"  id="comment-submit-textbox" rows="1" name="comment"></textarea>
                <input type="hidden" name="paragraph_id" value=<%=paragraph.id%>>
                <div class="spacer"></div>
                <div><input type="submit" class="btn btn-default" value="Submit"></div>
              </form>
            <%end%>
          </div>
        </div>   
      <% end %>
  </div>
</div>

<script>
var selectMode = false;
$(".comment-select-button").on("click", function(){
  selectMode = true;
});

if(selectMode === false){
  $( ".paragraph_body" ).click(function() {
    var target = $( this ).attr("data-target");
    var already_visible = $(target).is(":visible");
    
    // Hide all comments
    $('.comment_bar').hide();
    $('.side-comment').show();

    // only show if wasn't originally visible
    if (!already_visible) {
      $(target).show();
      $('.side-comment').hide();
    } // otherwise leave it hidden
  });
else{
  $(document).on("mouseup", function() {
    var selection = window.getSelection().getRangeAt(0);
    var toGetParagraphID = selection.commonAncestorContainer.parentNode;
    var paragraphID;

    if ($(toGetParagraphID).is('p')){
      paragraphID = $(toGetParagraphID.parentNode).attr('data-target').split('_')[3];
      paragraphFetcher = 2
    } else if ($(toGetParagraphID).is('div')){
      paragraphID = $(toGetParagraphID).attr('data-target').split('_')[3];
      paragraphFetcher = 1
    } else {
      paragraphID = $(toGetParagraphID.parentNode.parentNode).attr('data-target').split('_')[3];
      paragraphFetcher = 3
    }
    
    //display a little + to indicate adding comments.
    $.get('/scomment').then(function(id){
      var selectedText = selection.extractContents();
      var span= document.createElement("span");
      span.className="comment-select"
      span.setAttribute("id", "ID" + id);
      span.appendChild(selectedText);
      selection.insertNode(span);

      var paragraphText;
      if (paragraphFetcher === 1){
        paragraphText = $(toGetParagraphID)
      } else if (paragraphFetcher === 2){
        paragraphText = $(toGetParagraphID.parentNode)
      } else if (paragraphFetcher === 3){
        paragraphText = $(toGetParagraphID.parentNode.parentNode)
      };
      paragraphText = $(paragraphText)[0].innerHTML;

      
      console.log(paragraphText);
      $.post('/scomment', {pid: paragraphID, pt: paragraphText}).then(function(id)
        {
          location.href = '/docs/' + id;
        });
    });
  });
};
>>>>>>> experimental
</script>

